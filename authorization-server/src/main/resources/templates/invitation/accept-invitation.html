<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: html}">
<head>
    <th:block th:fragment="additional-head">
        <title>Accept Invitation - ChatCraft Auth</title>
    </th:block>
</head>
<body>
    <th:block th:fragment="content">
        <div class="auth-card">
            <!-- Invitation Header -->
            <div class="invitation-header">
                <h1>You're Invited!</h1>
                <p th:if="${invitation}" th:text="'Join ' + ${invitation.tenantName}">Join Organization</p>
            </div>

            <!-- Error Message -->
            <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
                <span th:text="${errorMessage}">Error message</span>
            </div>

            <!-- Invitation Details -->
            <div th:if="${invitation}" class="invitation-details">
                <h3>Invitation Details</h3>
                <div class="detail-row">
                    <span class="detail-label">Organization:</span>
                    <span class="detail-value" th:text="${invitation.tenantName}">Organization Name</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Your Username:</span>
                    <span class="detail-value" th:text="${invitation.username}">username</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Your Email:</span>
                    <span class="detail-value" th:text="${invitation.email}">user@example.com</span>
                </div>
                <div class="detail-row" th:if="${invitation.isTenantAdmin}">
                    <span class="detail-label">Role:</span>
                    <span class="detail-value text-primary">Administrator</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Invited by:</span>
                    <span class="detail-value" th:text="${invitation.invitedByUsername ?: 'System'}">Inviter</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Expires:</span>
                    <span class="detail-value" th:text="${#temporals.format(invitation.invitationExpiresAt, 'MMM dd, yyyy HH:mm')}">Expiration Date</span>
                </div>
            </div>

            <!-- Custom Message -->
            <div th:if="${invitation?.message}" class="alert alert-info">
                <strong>Message from inviter:</strong>
                <p th:text="${invitation.message}" class="mb-0">Custom message</p>
            </div>

            <!-- Account Setup Form -->
            <form th:action="@{/invitation/accept}" method="post" th:object="${acceptRequest}" id="acceptForm">
                <!-- CSRF Token -->
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                
                <!-- Hidden invitation token -->
                <input type="hidden" th:field="*{invitationToken}"/>

                <h3 class="text-primary mb-3">Set Up Your Account</h3>

                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="firstName" class="form-label">First Name</label>
                            <input type="text" 
                                   class="form-control"
                                   th:class="${#fields.hasErrors('firstName')} ? 'form-control is-invalid' : 'form-control'"
                                   id="firstName" 
                                   th:field="*{firstName}"
                                   placeholder="John">
                            <div th:if="${#fields.hasErrors('firstName')}" class="invalid-feedback">
                                <span th:errors="*{firstName}">First name error</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-col">
                        <div class="form-group">
                            <label for="lastName" class="form-label">Last Name</label>
                            <input type="text" 
                                   class="form-control"
                                   th:class="${#fields.hasErrors('lastName')} ? 'form-control is-invalid' : 'form-control'"
                                   id="lastName" 
                                   th:field="*{lastName}"
                                   placeholder="Doe">
                            <div th:if="${#fields.hasErrors('lastName')}" class="invalid-feedback">
                                <span th:errors="*{lastName}">Last name error</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="password" class="form-label">Password *</label>
                    <input type="password" 
                           class="form-control"
                           th:class="${#fields.hasErrors('password')} ? 'form-control is-invalid' : 'form-control'"
                           id="password" 
                           th:field="*{password}"
                           required 
                           minlength="8"
                           placeholder="Choose a strong password">
                    <div th:if="${#fields.hasErrors('password')}" class="invalid-feedback">
                        <span th:errors="*{password}">Password error</span>
                    </div>
                    <small class="text-muted">Minimum 8 characters</small>
                </div>

                <div class="form-group">
                    <label for="passwordConfirmation" class="form-label">Confirm Password *</label>
                    <input type="password" 
                           class="form-control"
                           th:class="${#fields.hasErrors('passwordConfirmation')} ? 'form-control is-invalid' : 'form-control'"
                           id="passwordConfirmation" 
                           th:field="*{passwordConfirmation}"
                           required 
                           placeholder="Confirm your password">
                    <div th:if="${#fields.hasErrors('passwordConfirmation')}" class="invalid-feedback">
                        <span th:errors="*{passwordConfirmation}">Password confirmation error</span>
                    </div>
                    <div id="passwordMatchError" class="invalid-feedback" style="display: none;">
                        Passwords do not match
                    </div>
                </div>

                <!-- Password Strength Indicator -->
                <div class="form-group">
                    <div class="password-strength">
                        <div class="strength-bar">
                            <div class="strength-fill" id="strengthFill"></div>
                        </div>
                        <small class="strength-text" id="strengthText">Enter a password</small>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-block" id="acceptBtn">
                    Accept Invitation & Create Account
                </button>
            </form>

            <!-- Additional Info -->
            <div class="text-center mt-4">
                <p class="text-muted">
                    <small>
                        By creating an account, you agree to our 
                        <a href="#" target="_blank" class="text-primary">Terms of Service</a> and 
                        <a href="#" target="_blank" class="text-primary">Privacy Policy</a>.
                    </small>
                </p>
            </div>
        </div>
    </th:block>

    <th:block th:fragment="additional-scripts">
        <style>
            .password-strength {
                margin-top: 0.5rem;
            }
            
            .strength-bar {
                height: 4px;
                background-color: var(--border-color);
                border-radius: 2px;
                overflow: hidden;
            }
            
            .strength-fill {
                height: 100%;
                width: 0%;
                transition: width 0.3s ease, background-color 0.3s ease;
                background-color: var(--danger-color);
            }
            
            .strength-text {
                display: block;
                margin-top: 0.25rem;
                color: var(--medium-gray);
            }
        </style>

        <script>
            // Password strength checker
            const passwordInput = document.getElementById('password');
            const confirmInput = document.getElementById('passwordConfirmation');
            const strengthFill = document.getElementById('strengthFill');
            const strengthText = document.getElementById('strengthText');
            const matchError = document.getElementById('passwordMatchError');

            function checkPasswordStrength(password) {
                let score = 0;
                let feedback = [];

                if (password.length >= 8) score++;
                else feedback.push('at least 8 characters');

                if (/[a-z]/.test(password)) score++;
                else feedback.push('lowercase letter');

                if (/[A-Z]/.test(password)) score++;
                else feedback.push('uppercase letter');

                if (/[0-9]/.test(password)) score++;
                else feedback.push('number');

                if (/[^a-zA-Z0-9]/.test(password)) score++;
                else feedback.push('special character');

                const strength = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong'][score];
                const colors = ['#dc3545', '#fd7e14', '#ffc107', '#28a745', '#20c997'][score];
                const width = (score / 5) * 100;

                strengthFill.style.width = width + '%';
                strengthFill.style.backgroundColor = colors;
                
                if (password.length === 0) {
                    strengthText.textContent = 'Enter a password';
                    strengthFill.style.width = '0%';
                } else if (feedback.length > 0) {
                    strengthText.textContent = `${strength} - Add: ${feedback.join(', ')}`;
                } else {
                    strengthText.textContent = strength + ' password';
                }
            }

            function checkPasswordMatch() {
                const password = passwordInput.value;
                const confirm = confirmInput.value;
                
                if (confirm.length > 0 && password !== confirm) {
                    confirmInput.classList.add('is-invalid');
                    matchError.style.display = 'block';
                } else {
                    confirmInput.classList.remove('is-invalid');
                    matchError.style.display = 'none';
                }
            }

            passwordInput.addEventListener('input', function() {
                checkPasswordStrength(this.value);
                if (confirmInput.value) {
                    checkPasswordMatch();
                }
            });

            confirmInput.addEventListener('input', checkPasswordMatch);

            // Form submission
            document.getElementById('acceptForm').addEventListener('submit', function(e) {
                const password = passwordInput.value;
                const confirm = confirmInput.value;
                
                if (password !== confirm) {
                    e.preventDefault();
                    checkPasswordMatch();
                    return false;
                }
                
                const btn = document.getElementById('acceptBtn');
                btn.classList.add('btn-loading');
                btn.disabled = true;
            });

            // Focus first empty input
            const firstNameInput = document.getElementById('firstName');
            if (!firstNameInput.value) {
                firstNameInput.focus();
            } else {
                passwordInput.focus();
            }
        </script>
    </th:block>
</body>
</html>